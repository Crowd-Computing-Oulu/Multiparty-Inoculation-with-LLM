<!DOCTYPE html>
<html lang="en">
{% include 'includes/head.html' %}
<body>
{% include 'includes/navbar.html' %}

<div class="container mt-5" style="max-width:1200px; margin:auto;"> 

    {% if finished %}
        <h1 class="text-center">✅ You’ve finished all conversation modes for this topic!</h1>
        <p class="text-center mt-3">You have finished all conversations for this topic. Please choose the next topic.</p>
        <div class="text-center">
            <a href="/topics" class="btn btn-primary mt-3">Choose Next Topic</a>
        </div>
    {% else %}
        <h1 class="text-center">Conversation ({{ mode|capitalize }})</h1>

        <!-- CHAT WINDOW -->
        <div id="chat" style="border:1px solid #ccc; max-height:450px; overflow-y:auto; padding:1rem; background:#fafafa;">
            <!-- messages inserted dynamically -->
        </div>
        
        <!-- Typing indicator below chat, fixed height reserves space so layout doesn't jump -->
        <div id="typing-indicator" style="
            height: 24px;
            padding: 5px 0;
            font-style: italic;
            color: #666;
            visibility: hidden;
        "></div>

        {% if step < total %}
            <a href="/next_mode/{{ lesson_id }}" class="btn btn-primary mt-3">Next Mode</a>
        {% else %}
            <a href="/next_mode/{{ lesson_id }}" class="btn btn-primary mt-3">Finish</a>
        {% endif %}
    {% endif %}

</div>

{% include 'includes/footer.html' %}

<script>
const chatHistory = {{ history|tojson }};
const mentionMap = {
    "Participant": "User",
    "MisInfoBot": "Participant 1",
    "SupportBot": "Participant 2",
    "RefutationalBot": "Participant 3",
    "PrebunkingBot": "Participant 4"
};

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, function(m) {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
    }
  });
}

function renderMessage(text) {
    text = escapeHTML(text);

    text = text.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener">$1</a>'
    );

    text = text.replace(
        /(https?:\/\/[^\s<>"']+)(?![^<]*<\/a>)/g,
        '<a href="$1" target="_blank" rel="noopener">$1</a>'
    );

    text = text.replace(/(^|[\s])@([A-Za-z0-9_]+)/g, (match, space, name) => {
        const newName = mentionMap[name] || name;
        return `${space}<span class="mention">@${newName}</span>`;
    });

    text = text.replace(/\n/g, "<br>");
    return text;
}

function getSpeakerData(speaker) {
    switch(speaker) {
        case 'Participant': return {name:'User', img:'/static/img/participant.png', class:'participant'};
        case 'MisInfoBot': return {name:'Participant 1', img:'/static/img/misinfo.png', class:'misinfo-bot'};
        case 'SupportBot': return {name:'Participant 2', img:'/static/img/support.png', class:'supportive-bot'};
        case 'RefutationalBot': return {name:'Participant 3', img:'/static/img/refutational.png', class:'refutational-bot'};
        case 'PrebunkingBot': return {name:'Participant 4', img:'/static/img/prebunking.png', class:'prebunking-bot'};
        default: return {name:'Bot', img:'/static/img/bot.png', class:'bot'};
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const chat = document.getElementById("chat");
    const typingEl = document.getElementById("typing-indicator");
    let index = 0;

    function scrollToBottom(el) {
        el.scrollIntoView({ behavior: "smooth", block: "end" });
    }

    function showNextMessage() {
        if (index >= chatHistory.length) return;

        const line = chatHistory[index];
        const colonIndex = line.indexOf(":");
        const rawSpeaker = line.substring(0, colonIndex).trim();
        const rawMsg = line.substring(colonIndex + 1).trim();
        const speakerData = getSpeakerData(rawSpeaker);

        function appendBubble() {
            typingEl.textContent = "";
            typingEl.style.visibility = "hidden";

            const messageEl = document.createElement("div");
            messageEl.className = `message d-flex align-items-start mb-3 ${speakerData.class}`;

            const img = document.createElement("img");
            img.src = speakerData.img;
            img.alt = speakerData.name;
            img.style = "width:40px; height:40px; border-radius:50%; margin-right:10px;";

            const msgText = document.createElement("div");
            msgText.className = "msg-text";
            msgText.innerHTML = `<strong class="speaker">${speakerData.name}:</strong>
                                 <span class="body">${renderMessage(rawMsg)}</span>`;

            messageEl.appendChild(img);
            messageEl.appendChild(msgText);
            chat.appendChild(messageEl);

            scrollToBottom(messageEl);
            index++;
            setTimeout(showNextMessage, 500);
        }

        if (rawSpeaker === 'Participant') {
            appendBubble(); // user messages show instantly
        } else {
            typingEl.textContent = `${speakerData.name} is typing...`;
            typingEl.style.visibility = "visible";
            scrollToBottom(typingEl);

            setTimeout(appendBubble, 10000); // bot messages delayed
        }
    }

    showNextMessage();
});
</script>

</body>
</html>
