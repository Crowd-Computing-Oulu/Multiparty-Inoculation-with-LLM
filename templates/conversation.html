<!DOCTYPE html>
<html lang="en">
{% include 'includes/head.html' %}
<body>
{% include 'includes/navbar.html' %}

<div class="container mt-1" style="max-width:1400px; margin:auto;;">

        <div class="text-center"><h1>Conversation</h1></div>

        <div class="alert alert-info" style="font-size: 1rem; padding: 0.3rem 0.6rem;">
            <p>This conversation is between two bots (Marty and Forty) and Conversant discussing the topic: "Binge drinking"</strong>.</p>

            <p>Please read the conversation carefully and analyze it.</p>
            <ol>
                <li class="mb-1">When the conversation ends, <strong>“Fill the form”</strong> button will be enabled.</li>
                <li class="mb-1">Click the <strong>“Fill the form”</strong> button to open the Google Form and submit your analysis.</li>
                <li class="mb-1"> After submitting the Google Form, you will receive a <strong>completion code</strong>.</li>
                <li class="mb-1">Enter the completion code on Prolific to complete the task. </li>
            </ol>
        </div>
        <!-- Fill Form button (shown after chat ends) -->
            <div id="fill-form-button" style="text-align:center; margin:20px;">
                <button id="fill-form-btn" class="btn btn-primary" onclick="showGoogleForm()" disabled>
                    Fill the Form
                </button>
            </div>

       <div style="display: flex; gap: 20px; max-width: 1200px; margin: auto; margin-bottom: 30px; height: 75vh; min-height: 600px;">
            

            <!-- Chat container -->
            <div class="card" id="chat" style="flex: 1; display: flex; flex-direction: column;  min-height:600px;">

                <div class="card-header d-flex flex-column p-1 justify-content-between">
                    <div class="d-flex w-100 align-items-center justify-content-between">
                        <p class="mb-0" style="font-weight: bold"><strong>Binge Drinking Chat</strong></p>
                    </div>
                    <div id="typing-indicator" style="font-style: italic; color: #010a06; font-size: 0.96em; min-height: 22px; padding-left:4px;"></div>
                </div>

                <div class="card-body overflow-y-scroll flex-grow-1" id="chat-messages" style="padding: 1rem; background:#fafafa; min-height:0;">
                </div>

                <div class="card-footer d-flex p-1" style="gap:0.6rem;">
                    <input type="text" id="msgInput" class="form-control no-interact" placeholder="" autocomplete="off" />
                    <button id="sendButton" class="btn btn-primary no-interact" type="button">
                        <img src="/static/img/paperplane.fill.png" width="24" alt="Send" style="margin-bottom: 2px;">
                    </button>
                </div>
            </div>

            <!-- Google Form container -->
            <div id="google-form-container" style="flex: 1; display: none; flex-direction: column; border: 1px solid #ddd; border-radius:4px; min-height:0;">
                <div class="card-header p-2" style="flex:0 0 auto;">
                    <h3 class="mb-0">Please fill out the form below:</h3>
                </div>
                <div class="card-body flex-grow-1" style="overflow:hidden; display:flex; flex-direction:column; min-height:0;">
                    <iframe id="google-form"
                        src="https://docs.google.com/forms/d/e/1FAIpQLScefwvGMj5rAerAB-mho8mA7hQHxsOKkqzEVlCUSWSL1bstdg/viewform?usp=pp_url&entry.1054632790={{ participant_number }}&embedded=true"
                        style="flex:1; width:100%; border:none; min-height:0;">
                    </iframe>
                </div>
            </div>


        </div>


        


        <!-- Finish button (shown after form is visible) -->
        <div id="finish-button" style="display:none; text-align:center; margin:20px;">
            <button class="btn btn-success" onclick="finishParticipant()">Finish</button>
        </div>

        

</div>

{% include 'includes/footer.html' %}

<script>
const chatHistory = {{ history|tojson | safe }};
const mentionMap = {
    "Participant": "Conversant",
    "MisInfoBot": "Marty",
    "SupportBot": "Forty",
    "RefutationalBot": "Forty",
    "PrebunkingBot": "Forty"
};

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
    }
  });
}

function renderMessage(text,speaker) {
    text = escapeHTML(text);
    text = text.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
    text = text.replace(/(https?:\/\/[^\s<>"']+)(?![^<]*<\/a>)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    text = text.replace(/(^|[\s])@([A-Za-z0-9_]+)/g, (match, space, name) => {
        if(name === speaker) return `${space}@${name}`;
        const newName = mentionMap[name] || name;
        return `${space}<span class="mention">@${newName}</span>`;
    });
    text = text.replace(/\n/g, "<br>");
    return text;
}

function getSpeakerData(speaker) {
    switch(speaker) {
        case 'Participant': return {name:'Conversant', img:'/static/img/participant.png', class:'user-message', justify:'justify-content-end', bgClass:'bg-primary', textColor:'text-white'};
        case 'MisInfoBot': return {name:'Marty', img:'/static/img/misinfo.png', class:'bot-message', justify:'justify-content-start', bgClass:'misinfo-bot', textColor:'text-dark'};
        case 'SupportBot': return {name:'Forty', img:'/static/img/supportive.png', class:'bot-message', justify:'justify-content-start', bgClass:'supportive-bot', textColor:'text-dark'};
        case 'RefutationalBot': return {name:'Forty', img:'/static/img/refutational.png', class:'bot-message', justify:'justify-content-start', bgClass:'refutational-bot', textColor:'text-dark'};
        case 'PrebunkingBot': return {name:'Forty', img:'/static/img/prebunking.png', class:'bot-message', justify:'justify-content-start', bgClass:'prebunking-bot', textColor:'text-dark'};
        default: return {name:'Bot', img:'/static/img/bot.png', class:'bot-message', justify:'justify-content-start', bgClass:'bg-light', textColor:'text-dark'};
    }
}
function showTypingIndicator(name, show) {
    const typingEl = document.getElementById("typing-indicator");
    if(show && name) {
        typingEl.style.visibility = "visible";
        typingEl.textContent = `${name} is typing...`;
    }
    else {
        typingEl.style.visibility = "hidden";
        typingEl.textContent = "";
    }
}


function showGoogleForm() {
    // Show the embedded Google Form
    document.getElementById("google-form-container").style.display = "flex";
    document.getElementById("fill-form-button").style.display = "none";

    // Immediately mark participant as complete
    fetch("{{ url_for('finish') }}")
        .then(response => {
            if (response.ok) {
                console.log("Participant marked as complete.");
            } else {
                console.error("Failed to mark participant as complete.");
            }
        })
        .catch(error => console.error("Error completing participant:", error));
}



document.addEventListener("DOMContentLoaded", () => {
    // Keep the button visible
    const fillFormButton = document.getElementById("fill-form-button");
    const formButton = document.getElementById("fill-form-btn");

    document.getElementById("google-form-container").style.display = "none";
    document.getElementById("finish-button").style.display = "none";

    formButton.disabled = true; // keep it disabled until convo ends

    const chatBody = document.getElementById("chat-messages");
    let index = 0;

    function scrollToBottom() {
        chatBody.scrollTop = chatBody.scrollHeight;
    }

    function appendMessage(speakerData, messageHtml) {
        const messageEl = document.createElement("div");
        messageEl.className = `d-flex flex-row ${speakerData.justify} mb-4 pt-1 ${speakerData.class}`;
        if (speakerData.justify === 'justify-content-end') {
            messageEl.innerHTML = `
                <p class="small p-2 me-3 mb-1 rounded-4 ${speakerData.bgClass} ${speakerData.textColor}"
                   style="max-width:600px; cursor:default;">
                   <strong class="speaker" style="display:block; font-weight:1200; margin-bottom:4px;">
                       ${speakerData.name}
                   </strong>
                   <span class="body">${messageHtml}</span>
                </p>
                <img src="${speakerData.img}" alt="${speakerData.name}"
                     style="width:40px; height:40px; border-radius:50%;">
            `;
        } else {
            messageEl.innerHTML = `
                <img src="${speakerData.img}" alt="${speakerData.name}"
                     style="width:40px; height:40px; border-radius:50%; margin-right:10px;">
                <p class="small p-2 mb-1 rounded-4 ${speakerData.bgClass} ${speakerData.textColor}"
                   style="max-width:600px; cursor:default;">
                   <strong class="speaker" style="display:block; font-weight:1200; margin-bottom:4px;">
                       ${speakerData.name}
                   </strong>
                   <span class="body">${messageHtml}</span>
                </p>
            `;
        }
        chatBody.appendChild(messageEl);
        scrollToBottom();
    }

    function showNextMessage() {
        if (index >= chatHistory.length) {
            // Enable the Fill Form button
            formButton.disabled = false;
            showTypingIndicator(null, false);
            return;
        }

        const line = chatHistory[index];
        const colonIndex = line.indexOf(":");
        const rawSpeaker = line.substring(0, colonIndex).trim();
        const rawMsg = line.substring(colonIndex + 1).trim();
        const speakerData = getSpeakerData(rawSpeaker);

        showTypingIndicator(speakerData.name, true);
        let delay = rawSpeaker === 'Participant' ? 10000 : 20000;

        setTimeout(() => {
            showTypingIndicator(null, false);
            appendMessage(speakerData, renderMessage(rawMsg, rawSpeaker));
            index++;
            showNextMessage();
        }, delay + 500);
    }

    showNextMessage();
});


function finishParticipant() {
    fetch("{{ url_for('finish') }}")
        .then(response => {
            if (response.ok) {
                // Hide chat and finish button
                document.getElementById("chat").style.display = "none";
                document.getElementById("finish-button").style.display = "none";
                const thankYouHtml = `
                    <div style="display:flex; justify-content:center; align-items:center; height:60vh; flex-direction:column; text-align:center;">
                        <h1>Thank you for participating in our experiment!</h1>
                    </div>
       `;
                document.querySelector(".container").innerHTML = thankYouHtml;
            }
        });
}


</script>

</body>
</html>
