<!DOCTYPE html>
<html lang="en">
{% include 'includes/head.html' %}
<body>
{% include 'includes/navbar.html' %}

<div class="container mt-1" style="max-width:1400px; margin:auto;"> 

    {% if finished %}
        <h1 class="text-center">✅ You’ve finished the conversation for this topic!</h1>
        <p class="text-center mt-3">You have finished the conversation for this topic.</p>
    {% else %}
       <h2 class="text-center">Conversation</h2>
       <!-- INTRODUCTION -->
        <div class="alert alert-info" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">
            <p>This conversation is between two bots(Marty and Forty) and Conversant discussing the topic: <strong>"Binge drinking"</strong></p>
            <p>Please read carefully and analyze the conversation. Once it is finished, a "Finish" button will appear, which will redirect you to a Google Form to submit your analysis.</p>
        </div>

        <!-- CHAT WINDOW -->
        <div id="chat" style="border:1px solid #ccc; max-height:450px; overflow-y:auto; padding:1rem; background:#fafafa;">
            <!-- messages inserted dynamically -->
        </div>
        
        <!-- Typing indicator below chat, fixed height reserves space so layout doesn't jump -->
        <div id="typing-indicator" style="
            height: 16px;
            padding: 5px 0;
            font-style: italic;
            color: #666;
            visibility: hidden;
        "></div>

        
        <div id="finish-button" style="display:none; text-align:center; margin-top:20px;">
            <a href="{{ url_for('finish') }}" class="btn btn-primary">Finish</a>
        </div>

        

    {% endif %}

</div>

{% include 'includes/footer.html' %}

<script>
const chatHistory = {{ history|tojson | safe }};
const mentionMap = {
    "Participant": "Conversant",
    "MisInfoBot": "Marty",
    "SupportBot": "Forty",
    "RefutationalBot": "Forty",
    "PrebunkingBot": "Forty"
};

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, function(m) {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
    }
  });
}

function renderMessage(text,speaker) {
    text = escapeHTML(text);

    text = text.replace(
        /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener">$1</a>'
    );

    text = text.replace(
        /(https?:\/\/[^\s<>"']+)(?![^<]*<\/a>)/g,
        '<a href="$1" target="_blank" rel="noopener">$1</a>'
    );

    text = text.replace(/(^|[\s])@([A-Za-z0-9_]+)/g, (match, space, name) => {
        if (name === speaker) return `${space}@${name}`;
        const newName = mentionMap[name] || name;
        return `${space}<span class="mention">@${newName}</span>`;
    });

    text = text.replace(/\n/g, "<br>");
    return text;
}

function getSpeakerData(speaker) {
    switch(speaker) {
        case 'Participant': return {name:'Conversant', img:'/static/img/participant.png', class:'participant'};
        case 'MisInfoBot': return {name:'Marty', img:'/static/img/misinfo.png', class:'misinfo-bot'};
        case 'SupportBot': return {name:'Forty', img:'/static/img/support.png', class:'supportive-bot'};
        case 'RefutationalBot': return {name:'Forty', img:'/static/img/refutational.png', class:'refutational-bot'};
        case 'PrebunkingBot': return {name:'Forty', img:'/static/img/prebunking.png', class:'prebunking-bot'};
        default: return {name:'Bot', img:'/static/img/bot.png', class:'bot'};
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const chat = document.getElementById("chat");
    const typingEl = document.getElementById("typing-indicator");
    let index = 0;

    function scrollToBottom(el) {
        el.scrollIntoView({ behavior: "smooth", block: "end" });
    }
    
        function showNextMessage() {
        if (index >= chatHistory.length) {
            // Show finish button only after all messages
            const finishBtn = document.getElementById("finish-button");
            if (finishBtn) finishBtn.style.display = "block";
            return;
        }

        const line = chatHistory[index];
        const colonIndex = line.indexOf(":");
        const rawSpeaker = line.substring(0, colonIndex).trim();
        const rawMsg = line.substring(colonIndex + 1).trim();
        const speakerData = getSpeakerData(rawSpeaker);

        function appendBubble() {
            typingEl.textContent = "";
            typingEl.style.visibility = "hidden";

            const messageEl = document.createElement("div");
            messageEl.className = `message d-flex align-items-start mb-3 ${speakerData.class}`;

            const img = document.createElement("img");
            img.src = speakerData.img;
            img.alt = speakerData.name;
            img.style = "width:40px; height:40px; border-radius:50%; margin-right:10px;";

            const msgText = document.createElement("div");
            msgText.className = "msg-text";
            msgText.innerHTML = `<strong class="speaker">${speakerData.name}:</strong>
                                <span class="body">${renderMessage(rawMsg, rawSpeaker)}</span>`;

            messageEl.appendChild(img);
            messageEl.appendChild(msgText);
            chat.appendChild(messageEl);

            chat.scrollTop = chat.scrollHeight; // scroll to bottom
            index++;
            setTimeout(showNextMessage, 500);
        }

        if (rawSpeaker === 'Participant') {
            if (index === 0) {
                appendBubble();
            } else {
                setTimeout(appendBubble, 5000);
            }
        } else {
            typingEl.textContent = `${speakerData.name} is typing...`;
            typingEl.style.visibility = "visible";
            chat.scrollTop = chat.scrollHeight;
            setTimeout(appendBubble, 10000); 
        }
    }

    const finishBtn = document.getElementById('finish-btn');
    if (finishBtn) {
        finishBtn.addEventListener('click', () => {
            document.getElementById('chat').style.display = 'none';
            document.getElementById('typing-indicator').style.display = 'none';
            finishBtn.style.display = 'none';
            document.getElementById('finished-message').style.display = 'block';
        });
    }
    showNextMessage();
});
</script>

</body>
</html>
